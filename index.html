const S_URL = "https://itmwgzryoeeehymbyrdz.supabase.co", 
      S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bXdnenJ5b2VlZWh5bWJ5cmR6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODY2NzcxNywiZXhwIjoyMDg0MjQzNzE3fQ.YJNdFs468N3vIqzvEfQPzg_jAGXsx-rN8YDMqQX793g", 
      sb = supabase.createClient(S_URL, S_KEY), tg = window.Telegram.WebApp;

let userId = tg.initDataUnsafe?.user?.id?.toString() || "u_test", 
    vids = [], curr = 0, coins = 0, player, timerId;

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function boot() {
    tg.expand();
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    let { data: p } = await sb.from('profiles').select('*').eq('user_id', userId).single();
    if (p) { 
        coins = p.coins; 
        document.getElementById('coin-count').innerText = coins; 
    } else {
        await sb.from('profiles').insert({ user_id: userId, coins: 0 });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (—Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä—è–º–æ –≤ –∑–∞–ø—Ä–æ—Å–µ)
    let { data: v } = await sb.from('videos')
        .select('*')
        .order('created_at', { ascending: false });

    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –µ—â–µ –Ω—É–∂–Ω—ã
    vids = (v || []).filter(item => (item.views_done || 0) < item.views_needed);
    
    if (vids.length > 0) {
        updateVideoDisplay();
    } else {
        document.getElementById('watch-btn-text').innerText = "–ó–ê–î–ê–ù–ò–ô –ü–û–ö–ê –ù–ï–¢";
    }
}

function onYouTubeIframeAPIReady() { boot(); }

function updateVideoDisplay() { 
    if(vids[curr]) {
        const reward = Math.floor((vids[curr].duration || 60) / 60 * 50);
        document.getElementById('watch-btn-text').innerText = `‚ñ∂ –°–ú–û–¢–†–ï–¢–¨ (+${reward} üí∞)`;
        loadVid(vids[curr].youtube_id);
    }
}

function loadVid(id) { 
    if (player && typeof player.cueVideoById === 'function') { 
        player.cueVideoById(id); 
    } else {
        player = new YT.Player('video-player', { 
            height: '100%', width: '100%', videoId: id, 
            playerVars: { 'controls': 0, 'rel': 0, 'playsinline': 1 } 
        }); 
    }
}

function startWatching() {
    if(!player || !vids[curr]) return;
    
    player.playVideo();
    document.getElementById('watch-controls').style.display='none';
    document.getElementById('timer-display').style.display='block';
    
    let t = vids[curr].duration || 60;
    document.getElementById('seconds').innerText = t;

    if (timerId) clearInterval(timerId); // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –±—ã–ª

    timerId = setInterval(() => {
        t--; 
        document.getElementById('seconds').innerText = t;
        if(t <= 0) { 
            clearInterval(timerId); 
            player.pauseVideo(); 
            finish(); 
        }
    }, 1000);
}

async function finish() {
    const video = vids[curr];
    const reward = Math.floor(video.duration / 60 * 50);
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–Ω–µ—Ç—ã
    coins += reward;
    await sb.from('profiles').update({ coins }).eq('user_id', userId);
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    const newViewsDone = (video.views_done || 0) + 1;
    
    if (newViewsDone >= video.views_needed) {
        // –ï–°–õ–ò –ü–†–û–°–ú–û–¢–†–´ –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨ - –£–î–ê–õ–Ø–ï–ú –í–ò–î–ï–û
        await sb.from('videos').delete().eq('id', video.id);
    } else {
        // –ò–ù–ê–ß–ï - –ü–†–û–°–¢–û –û–ë–ù–û–í–õ–Ø–ï–ú –°–ß–ï–¢–ß–ò–ö
        await sb.from('videos').update({ views_done: newViewsDone }).eq('id', video.id);
    }

    tg.showAlert(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${reward} –º–æ–Ω–µ—Ç!`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
    document.getElementById('coin-count').innerText = coins;
    document.getElementById('timer-display').style.display='none';
    document.getElementById('watch-controls').style.display='flex';
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
    boot(); 
}

// –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function nextVid() { if(vids.length) { curr = (curr + 1) % vids.length; updateVideoDisplay(); } }
function prevVid() { if(vids.length) { curr = (curr - 1 + vids.length) % vids.length; updateVideoDisplay(); } }

// –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–ó–∞–∫–∞–∑—ã, –ú–∞–≥–∞–∑–∏–Ω)
async function loadMyOrders() {
    const list = document.getElementById('orders-list');
    list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    let { data: myV } = await sb.from('videos').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    if(!myV || myV.length === 0) { list.innerHTML = "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤"; return; }
    list.innerHTML = myV.map(v => `
        <div class="order-card">
            <button class="btn-delete" onclick="deleteVid(${v.id})">–£–¥–∞–ª–∏—Ç—å</button>
            <b>–í–∏–¥–µ–æ: ${v.youtube_id}</b><br>
            –ü—Ä–æ–≥—Ä–µ—Å—Å: ${v.views_done || 0}/${v.views_needed} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
        </div>
    `).join('');
}

async function deleteVid(id) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?")) {
        await sb.from('videos').delete().eq('id', id);
        loadMyOrders();
        tg.showAlert("–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω.");
    }
}

async function uploadVid() {
    const url = document.getElementById('yt-url').value;
    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ ID
    const vidId = url.match(/(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?\/?.*(?:watch|embed)?(?:.*v=|v\/|\/)([\w\-_]+)\&?/)?.[1];
    
    const count = parseInt(document.getElementById('v-count').value);
    const time = parseInt(document.getElementById('v-time').value);
    const price = Math.floor(count * (time / 60) * 100);

    if (!vidId) return tg.showAlert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ YouTube");
    if (coins < price) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");

    await sb.from('videos').insert([{ 
        youtube_id: vidId, 
        views_needed: count, 
        duration: time, 
        user_id: userId, 
        views_done: 0 
    }]);

    coins -= price;
    await sb.from('profiles').update({ coins }).eq('user_id', userId);
    
    tg.showAlert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
    location.reload();
}

function tab(n, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.getElementById('page-' + n).classList.add('active-page');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    if (timerId) { clearInterval(timerId); document.getElementById('timer-display').style.display='none'; document.getElementById('watch-controls').style.display='flex'; if(player) player.pauseVideo(); }
}

function updPr() { 
    const count = document.getElementById('v-count').value || 0;
    const time = document.getElementById('v-time').value || 60;
    document.getElementById('total-price').innerText = Math.floor(count * (time / 60) * 100); 
}
