<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { --tg-bg: #1a1b1e; --primary: #0088cc; --gold: #ffeb3b; --card-bg: #25262b; --red: #ff4444; }
        body { background: var(--tg-bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; background: #111; z-index: 100; }
        .user-info { display: flex; flex-direction: column; font-size: 14px; }
        .page { display: none; flex: 1; flex-direction: column; padding: 20px; text-align: center; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px; }
        .active-page { display: flex; }
        .video-box { background: #000; width: 100%; aspect-ratio: 16/9; border-radius: 20px; border: 2px solid #333; position: relative; overflow: hidden; }
        #video-player { width: 100%; height: 100%; }
        .btn-action { background: var(--primary); border: none; color: white; padding: 18px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 15px; cursor: pointer; }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #0b0c0d; color: white; font-size: 16px; box-sizing: border-box; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .shop-item { background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; }
        .btn-buy { background: #4caf50; border: none; color: white; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .bonus-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 20px; }
        .nav-bar { background: #111; display: flex; justify-content: space-around; padding: 10px 0 25px 0; border-top: 1px solid #222; position: fixed; bottom: 0; width: 100%; z-index: 1000; }
        .nav-btn { color: #5c5f66; font-size: 10px; cursor: pointer; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn i { font-style: normal; font-size: 18px; }
        .nav-btn.active { color: var(--primary); }
        .order-card { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-bottom: 10px; text-align: left; border: 1px solid #333; position: relative; }
        .btn-delete { background: var(--red); border: none; color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; float: right; }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <span id="user-name" style="font-weight: bold;">üë§ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span style="font-size: 10px; color: #888;">UVIEW PRO ID: <span id="display-id">0</span></span>
        </div>
        <div style="color:var(--gold); font-weight: bold;">üí∞ <span id="coin-count">0</span></div>
    </div>

    <div id="page-home" class="page active-page">
        <div class="video-box"><div id="video-player"></div></div>
        <div id="watch-controls" style="width:100%">
            <button class="btn-action" id="watch-btn-text" onclick="startWatching()">‚ñ∂ –°–ú–û–¢–†–ï–¢–¨</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action" style="flex:1; background:#333" onclick="prevVid()">‚¨Ö</button>
                <button class="btn-action" style="flex:1; background:#333" onclick="nextVid()">‚û°</button>
            </div>
        </div>
        <div id="timer-display" style="display:none; font-size:24px; color:var(--gold); margin-top:20px; font-weight:bold;">‚è≥ <span id="seconds">0</span> —Å–µ–∫.</div>
    </div>

    <div id="page-upload" class="page">
        <h3>–ù–û–í–û–ï –ó–ê–î–ê–ù–ò–ï</h3>
        <input type="text" id="yt-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube">
        <input type="number" id="v-count" value="10" oninput="updPr()">
        <select id="v-time" onchange="updPr()">
            <option value="60">60 —Å–µ–∫—É–Ω–¥</option>
            <option value="180">180 —Å–µ–∫—É–Ω–¥</option>
            <option value="260">260 —Å–µ–∫—É–Ω–¥</option>
        </select>
        <div style="margin:20px 0; font-size:18px;">–¶–µ–Ω–∞ –∑–∞–∫–∞–∑–∞: <span id="total-price" style="color:var(--gold)">1000</span>üí∞</div>
        <button class="btn-action" onclick="uploadVid()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
    </div>

    <div id="page-orders" class="page">
        <h3>üìä –ú–û–ò –ó–ê–ö–ê–ó–´</h3>
        <div id="orders-list"></div>
    </div>

    <div id="page-shop" class="page">
        <h3>üéÅ –ë–û–ù–£–°–´ –ò –ú–ê–ì–ê–ó–ò–ù</h3>
        <div id="bonus-card" class="bonus-card">
            <h4>–ë–æ–Ω—É—Å –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É</h4>
            <button class="btn-action" onclick="openChannel()">1. –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø</button>
            <button id="bonus-claim-btn" class="btn-action" style="display:none; background:var(--gold); color:black" onclick="claimBonus()">2. –ó–ê–ë–†–ê–¢–¨ 5000</button>
        </div>
        <div class="shop-grid">
            <div class="shop-item"><b>5,000</b><span>$1.99</span><button class="btn-buy" onclick="buyProcess()">–ö–£–ü–ò–¢–¨</button></div>
            <div class="shop-item"><b>15,000</b><span>$4.99</span><button class="btn-buy" onclick="buyProcess()">–ö–£–ü–ò–¢–¨</button></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="tab('home', this)"><i>üè†</i>–õ–ï–ù–¢–ê</div>
        <div class="nav-btn" onclick="tab('upload', this)"><i>üì∑</i>–ó–ê–ì–†–£–ó–ö–ê</div>
        <div class="nav-btn" onclick="tab('orders', this); loadMyOrders();"><i>üìä</i>–ó–ê–ö–ê–ó–´</div>
        <div class="nav-btn" onclick="tab('shop', this)"><i>üõí</i>–ú–ê–ì–ê–ó–ò–ù</div>
    </div>

    <script>
        const S_URL = "https://itmwgzryoeeehymbyrdz.supabase.co", 
              S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bXdnenJ5b2VlZWh5bWJ5cmR6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODY2NzcxNywiZXhwIjoyMDg0MjQzNzE3fQ.YJNdFs468N3vIqzvEfQPzg_jAGXsx-rN8YDMqQX793g", 
              sb = supabase.createClient(S_URL, S_KEY), tg = window.Telegram.WebApp;

        let userId = tg.initDataUnsafe?.user?.id?.toString() || "u_test", 
            userName = tg.initDataUnsafe?.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            vids = [], curr = 0, coins = 0, player, timerId, hasBonus = false;

        async function boot() {
            tg.expand();
            // –í—ã–≤–æ–¥ –∏–º–µ–Ω–∏ –∏ ID –≤ —Ö–µ–¥–µ—Ä
            document.getElementById('user-name').innerText = "üë§ " + userName;
            document.getElementById('display-id').innerText = userId;

            // 1. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ Supabase
            let { data: p, error } = await sb.from('profiles').select('*').eq('user_id', userId).single();
            
            if (p) { 
                coins = p.coins; 
                hasBonus = p.bonus_claimed;
                document.getElementById('coin-count').innerText = coins; 
                if (hasBonus) document.getElementById('bonus-card').innerHTML = "<h4>‚úÖ –ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω</h4>";
            } else {
                // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ ‚Äî —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                await sb.from('profiles').insert({ user_id: userId, coins: 0, bonus_claimed: false });
                document.getElementById('coin-count').innerText = 0;
            }

            await loadAllVideos();
        }

        async function loadAllVideos() {
            let { data: v } = await sb.from('videos').select('*').order('created_at', { ascending: false });
            vids = (v || []).filter(item => (item.views_done || 0) < item.views_needed);
            if (vids.length > 0) updateVideoDisplay();
            else document.getElementById('watch-btn-text').innerText = "–ó–ê–î–ê–ù–ò–ô –ù–ï–¢";
        }

        function onYouTubeIframeAPIReady() { boot(); }

        function updateVideoDisplay() { 
            if(vids[curr]) {
                const reward = Math.floor((vids[curr].duration || 60) / 60 * 50);
                document.getElementById('watch-btn-text').innerText = `‚ñ∂ –°–ú–û–¢–†–ï–¢–¨ (+${reward} üí∞)`;
                loadVid(vids[curr].youtube_id);
            }
        }

        function loadVid(id) { 
            if (player && typeof player.cueVideoById === 'function') player.cueVideoById(id); 
            else player = new YT.Player('video-player', { height: '100%', width: '100%', videoId: id, playerVars: { 'controls': 0, 'rel': 0, 'playsinline': 1 } }); 
        }

        function startWatching() {
            if(!player || !vids[curr]) return;
            player.playVideo();
            document.getElementById('watch-controls').style.display='none';
            document.getElementById('timer-display').style.display='block';
            let t = vids[curr].duration || 60;
            document.getElementById('seconds').innerText = t;
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                t--; document.getElementById('seconds').innerText = t;
                if(t <= 0) { clearInterval(timerId); player.pauseVideo(); finish(); }
            }, 1000);
        }

        async function finish() {
            const video = vids[curr];
            const reward = Math.floor(video.duration / 60 * 50);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –ë–ê–ó–£
            coins += reward;
            const { error: pErr } = await sb.from('profiles').update({ coins: coins }).eq('user_id', userId);
            
            if (pErr) console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:", pErr);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            const newViews = (video.views_done || 0) + 1;
            if (newViews >= video.views_needed) await sb.from('videos').delete().eq('id', video.id);
            else await sb.from('videos').update({ views_done: newViews }).eq('id', video.id);
            
            tg.showAlert(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${reward} –º–æ–Ω–µ—Ç!`);
            document.getElementById('coin-count').innerText = coins;
            document.getElementById('timer-display').style.display='none';
            document.getElementById('watch-controls').style.display='flex';
            await loadAllVideos();
        }

        async function claimBonus() {
            if (hasBonus) return;
            coins += 5000;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –º–æ–Ω–µ—Ç—ã, –∏ —Å—Ç–∞—Ç—É—Å –±–æ–Ω—É—Å–∞
            await sb.from('profiles').update({ coins: coins, bonus_claimed: true }).eq('user_id', userId);
            hasBonus = true;
            document.getElementById('coin-count').innerText = coins;
            document.getElementById('bonus-card').innerHTML = "<h4>‚úÖ –ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω</h4>";
            tg.showAlert("5000 –º–æ–Ω–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–æ!");
        }

        function openChannel() { tg.openTelegramLink("https://t.me/edgar1984_g1p"); document.getElementById('bonus-claim-btn').style.display = 'block'; }
        function tab(n, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + n).classList.add('active-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            if (timerId) clearInterval(timerId);
        }
        function updPr() { 
            const count = document.getElementById('v-count').value || 0;
            const time = document.getElementById('v-time').value || 60;
            document.getElementById('total-price').innerText = Math.floor(count * (time / 60) * 100); 
        }
        async function loadMyOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            let { data: myV } = await sb.from('videos').select('*').eq('user_id', userId);
            if(!myV || myV.length === 0) { list.innerHTML = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤"; return; }
            list.innerHTML = myV.map(v => `<div class="order-card"><button class="btn-delete" onclick="deleteVid(${v.id})">–£–¥–∞–ª–∏—Ç—å</button><b>ID: ${v.youtube_id}</b><br>–ì–æ—Ç–æ–≤–æ: ${v.views_done || 0}/${v.views_needed}</div>`).join('');
        }
        async function deleteVid(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { await sb.from('videos').delete().eq('id', id); loadMyOrders(); } }
        async function uploadVid() {
            const url = document.getElementById('yt-url').value;
            const vidId = url.match(/(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?\/?.*(?:watch|embed)?(?:.*v=|v\/|\/)([\w\-_]+)\&?/)?.[1];
            const price = parseInt(document.getElementById('total-price').innerText);
            if (!vidId || coins < price) return tg.showAlert("–û—à–∏–±–∫–∞ –∏–ª–∏ –º–∞–ª–æ –º–æ–Ω–µ—Ç!");
            await sb.from('videos').insert([{ youtube_id: vidId, views_needed: parseInt(document.getElementById('v-count').value), duration: parseInt(document.getElementById('v-time').value), user_id: userId, views_done: 0 }]);
            coins -= price; await sb.from('profiles').update({ coins }).eq('user_id', userId);
            tg.showAlert("–ì–æ—Ç–æ–≤–æ!"); location.reload();
        }
        function nextVid() { if(vids.length) { curr = (curr + 1) % vids.length; updateVideoDisplay(); } }
        function prevVid() { if(vids.length) { curr = (curr - 1 + vids.length) % vids.length; updateVideoDisplay(); } }
        function buyProcess() { tg.openTelegramLink("https://t.me/CryptoBot?start=pay"); }
    </script>
</body>
</html>
