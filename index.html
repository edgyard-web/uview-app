<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { --tg-bg: #1a1b1e; --primary: #0088cc; --gold: #ffeb3b; --card-bg: #25262b; --red: #ff4444; --green: #4caf50; }
        body { background: var(--tg-bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; background: #111; }
        .user-info { display: flex; flex-direction: column; font-size: 14px; }
        .page { display: none; flex: 1; flex-direction: column; padding: 20px; text-align: center; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px; }
        .active-page { display: flex; }
        .video-box { background: #000; width: 100%; aspect-ratio: 16/9; border-radius: 20px; border: 2px solid #333; overflow: hidden; }
        #video-player { width: 100%; height: 100%; }
        .btn-action { background: var(--primary); border: none; color: white; padding: 18px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .bonus-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 15px; }
        .nav-bar { background: #111; display: flex; justify-content: space-around; padding: 10px 0 25px 0; border-top: 1px solid #222; position: fixed; bottom: 0; width: 100%; }
        .nav-btn { color: #5c5f66; font-size: 10px; cursor: pointer; text-align: center; flex: 1; }
        .nav-btn.active { color: var(--primary); }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <span id="user-name" style="font-weight: bold;">üë§ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span style="font-size: 10px; color: #888;">ID: <span id="display-id">0</span></span>
        </div>
        <div style="color:var(--gold); font-weight: bold;">üí∞ <span id="coin-count">0</span></div>
    </div>

    <div id="page-home" class="page active-page">
        <div class="video-box"><div id="video-player"></div></div>
        <div id="watch-controls">
            <button class="btn-action" id="watch-btn-text" onclick="startWatching()">‚ñ∂ –°–ú–û–¢–†–ï–¢–¨</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action" style="flex:1; background:#333" onclick="prevVid()">‚¨Ö</button>
                <button class="btn-action" style="flex:1; background:#333" onclick="nextVid()">‚û°</button>
            </div>
        </div>
        <div id="timer-display" style="display:none; font-size:24px; color:var(--gold); margin-top:20px; font-weight:bold;">‚è≥ <span id="seconds">0</span> —Å–µ–∫.</div>
    </div>

    <div id="page-shop" class="page">
        <h3>üéÅ –ë–û–ù–£–°–´</h3>
        
        <div class="bonus-card" style="border-color: var(--green);">
            <h4>üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</h4>
            <button id="daily-btn" class="btn-action" style="background: var(--green);" onclick="claimDaily()">–ó–ê–ë–†–ê–¢–¨ 500üí∞</button>
        </div>

        <div id="bonus-box" class="bonus-card">
            <h4>üì¢ –†–∞–∑–æ–≤—ã–π –±–æ–Ω—É—Å (5000)</h4>
            <button class="btn-action" onclick="openChannel()">1. –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø</button>
            <button id="bonus-claim-btn" class="btn-action" style="display:none; background:var(--gold); color:black" onclick="claimBonus()">2. –ü–û–õ–£–ß–ò–¢–¨ 5000üí∞</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="tab('home', this)">üè† –õ–ï–ù–¢–ê</div>
        <div class="nav-btn" onclick="tab('shop', this)">üõí –ú–ê–ì–ê–ó–ò–ù</div>
    </div>

    <script>
        const S_URL = "https://itmwgzryoeeehymbyrdz.supabase.co", 
              S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bXdnenJ5b2VlZWh5bWJ5cmR6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODY2NzcxNywiZXhwIjoyMDg0MjQzNzE3fQ.YJNdFs468N3vIqzvEfQPzg_jAGXsx-rN8YDMqQX793g", 
              sb = supabase.createClient(S_URL, S_KEY), tg = window.Telegram.WebApp;

        let userId = tg.initDataUnsafe?.user?.id?.toString() || "u_test", 
            userName = tg.initDataUnsafe?.user?.first_name || "User",
            coins = 0, lastDailyDate = "", player, vids = [], curr = 0;

        async function boot() {
            tg.expand();
            document.getElementById('user-name').innerText = userName;
            document.getElementById('display-id').innerText = userId;

            let { data: p } = await sb.from('profiles').select('*').eq('user_id', userId).single();
            
            if (!p) {
                await sb.from('profiles').insert({ user_id: userId, coins: 0, bonus_claimed: false, last_daily: "" });
                coins = 0;
            } else {
                coins = p.coins;
                lastDailyDate = p.last_daily;
                if (p.bonus_claimed) document.getElementById('bonus-box').style.display = 'none';
            }
            document.getElementById('coin-count').innerText = coins;
            loadAllVideos();
        }

        async function loadAllVideos() {
            let { data: v } = await sb.from('videos').select('*');
            vids = v || [];
            if (vids.length > 0) updateVideoDisplay();
        }

        function onYouTubeIframeAPIReady() { boot(); }

        function updateVideoDisplay() {
            if (!vids[curr]) return;
            const reward = Math.floor(vids[curr].duration / 60 * 50);
            document.getElementById('watch-btn-text').innerText = `‚ñ∂ –°–ú–û–¢–†–ï–¢–¨ (+${reward} üí∞)`;
            if (player) player.cueVideoById(vids[curr].youtube_id);
            else player = new YT.Player('video-player', { height: '100%', width: '100%', videoId: vids[curr].youtube_id, playerVars: {'controls':0} });
        }

        // --- –õ–û–ì–ò–ö–ê –ï–ñ–ï–î–ù–ï–í–ù–û–ì–û –ë–û–ù–£–°–ê ---
        async function claimDaily() {
            const today = new Date().toLocaleDateString();
            if (lastDailyDate === today) {
                tg.showAlert("–í—ã —É–∂–µ –∑–∞–±–∏—Ä–∞–ª–∏ –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞.");
                return;
            }

            const newBalance = coins + 500;
            const { error } = await sb.from('profiles').update({ 
                coins: newBalance, 
                last_daily: today 
            }).eq('user_id', userId);

            if (!error) {
                coins = newBalance;
                lastDailyDate = today;
                document.getElementById('coin-count').innerText = coins;
                tg.showAlert("–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 500üí∞ –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥!");
            }
        }

        // --- –ë–û–ù–£–° –ó–ê –ü–û–î–ü–ò–°–ö–£ ---
        function openChannel() {
            tg.openTelegramLink("https://t.me/edgar1984_g1p");
            document.getElementById('bonus-claim-btn').style.display = 'block';
        }

        async function claimBonus() {
            const newBalance = coins + 5000;
            const { error } = await sb.from('profiles').update({ 
                coins: newBalance, 
                bonus_claimed: true 
            }).eq('user_id', userId);

            if (!error) {
                coins = newBalance;
                document.getElementById('coin-count').innerText = coins;
                document.getElementById('bonus-box').style.display = 'none';
                tg.showAlert("–ë–æ–Ω—É—Å 5000üí∞ –Ω–∞—á–∏—Å–ª–µ–Ω!");
            }
        }

        function tab(n, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + n).classList.add('active-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function startWatching() {
            if(!player) return;
            player.playVideo();
            document.getElementById('watch-controls').style.display='none';
            document.getElementById('timer-display').style.display='block';
            let t = vids[curr].duration;
            document.getElementById('seconds').innerText = t;
            let timerId = setInterval(async () => {
                t--; document.getElementById('seconds').innerText = t;
                if(t <= 0) {
                    clearInterval(timerId);
                    const reward = Math.floor(vids[curr].duration / 60 * 50);
                    const newBalance = coins + reward;
                    await sb.from('profiles').update({ coins: newBalance }).eq('user_id', userId);
                    tg.showAlert(`–ì–æ—Ç–æ–≤–æ! +${reward}üí∞`);
                    location.reload();
                }
            }, 1000);
        }

        function nextVid() { curr = (curr + 1) % vids.length; updateVideoDisplay(); }
        function prevVid() { curr = (curr - 1 + vids.length) % vids.length; updateVideoDisplay(); }
    </script>
</body>
</html>
